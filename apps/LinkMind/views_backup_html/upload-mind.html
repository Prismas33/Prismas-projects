<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>LinkMind - Nova Ideia</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <meta name="theme-color" content="#4f46e5">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1><a href="/dashboard">üß† LinkMind</a></h1>
                <nav>
                    <a href="/dashboard" class="btn btn-secondary">‚Üê Voltar</a>
                </nav>
            </div>
        </header>

        <main class="upload-mind">
            <div class="form-container">
                <h2>üí° Nova Ideia</h2>
                <p>Capture sua inspira√ß√£o e organize seus pensamentos</p>

                <form id="ideaForm" class="idea-form">
                    <div class="form-group">
                        <label for="title">Quem/O qu√™</label>
                        <div class="autocomplete-container">
                            <input type="text" id="title" name="title" placeholder="Digite o t√≠tulo da sua ideia..." required>
                            <div id="suggestions" class="suggestions-list"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Data de In√≠cio (opcional)</label>
                            <input type="date" id="startDate" name="startDate">
                        </div>

                        <div class="form-group">
                            <label for="endDate">Data de Fim (opcional)</label>
                            <input type="date" id="endDate" name="endDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Descri√ß√£o</label>
                        <textarea id="description" name="description" placeholder="Descreva sua ideia em detalhes..." rows="6" required></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            üíæ Salvar Ideia
                        </button>
                        
                        <button type="button" id="notificationBtn" class="btn btn-outline">
                            üîî Criar Notifica√ß√£o
                        </button>
                    </div>
                </form>

                <div id="message" class="message"></div>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="/js/firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('ideaForm');
            const titleInput = document.getElementById('title');
            const suggestionsContainer = document.getElementById('suggestions');
            const messageDiv = document.getElementById('message');
            const notificationBtn = document.getElementById('notificationBtn');
            
            let suggestions = [];
            let debounceTimer;

            // Carregar sugest√µes para autocomplete
            async function loadSuggestions() {
                try {
                    const response = await fetch('/api/suggestions');
                    if (response.ok) {
                        const data = await response.json();
                        suggestions = data.suggestions;
                    }
                } catch (error) {
                    console.error('Erro ao carregar sugest√µes:', error);
                }
            }

            // Filtrar e exibir sugest√µes
            function showSuggestions(query) {
                if (!query || query.length < 2) {
                    suggestionsContainer.innerHTML = '';
                    return;
                }

                const filtered = suggestions.filter(suggestion => 
                    suggestion.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 5);

                if (filtered.length === 0) {
                    suggestionsContainer.innerHTML = '';
                    return;
                }

                const suggestionsHTML = filtered.map(suggestion => 
                    `<div class="suggestion-item" data-value="${escapeHtml(suggestion)}">${escapeHtml(suggestion)}</div>`
                ).join('');

                suggestionsContainer.innerHTML = suggestionsHTML;

                // Adicionar event listeners para as sugest√µes
                suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        titleInput.value = this.dataset.value;
                        suggestionsContainer.innerHTML = '';
                        titleInput.focus();
                    });
                });
            }

            // Autocomplete no campo t√≠tulo
            titleInput.addEventListener('input', function() {
                const query = this.value;
                
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    showSuggestions(query);
                }, 300);
            });

            // Ocultar sugest√µes quando clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    suggestionsContainer.innerHTML = '';
                }
            });

            // Submiss√£o do formul√°rio
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const ideaData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    startDate: formData.get('startDate') || null,
                    endDate: formData.get('endDate') || null
                };

                try {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Salvando...';

                    const response = await fetch('/api/ideas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(ideaData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('Ideia salva com sucesso!', 'success');
                        form.reset();
                        // Recarregar sugest√µes
                        await loadSuggestions();
                    } else {
                        showMessage(data.error, 'error');
                    }
                } catch (error) {
                    showMessage('Erro ao salvar ideia. Tente novamente.', 'error');
                } finally {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üíæ Salvar Ideia';
                }
            });

            // Bot√£o de notifica√ß√£o
            notificationBtn.addEventListener('click', function() {
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        createNotification();
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                createNotification();
                            }
                        });
                    } else {
                        showMessage('Notifica√ß√µes foram negadas. Habilite nas configura√ß√µes do navegador.', 'error');
                    }
                } else {
                    showMessage('Notifica√ß√µes n√£o s√£o suportadas neste navegador.', 'error');
                }
            });

            function createNotification() {
                const title = titleInput.value || 'Nova Ideia';
                const description = document.getElementById('description').value || 'Sem descri√ß√£o';
                
                new Notification(`LinkMind: ${title}`, {
                    body: description.substring(0, 100) + (description.length > 100 ? '...' : ''),
                    icon: '/images/icon-192.png',
                    tag: 'linkmind-idea'
                });
                
                showMessage('Notifica√ß√£o criada!', 'success');
            }

            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.className = `message ${type}`;
                
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'message';
                }, 5000);
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Inicializar
            loadSuggestions();
        });
    </script>
</body>
</html>
